#!/usr/bin/env node

'use strict';

var debug = require('debug')('Liqueed');
var db = require('../utils/db');
var app = require('../app');

var config = require('../config.json');
var pservices = require('../services/project');

app.set('port', process.env.PORT || 3000);

if (config.mongodb)
    db.useDb(config.mongodb.name, config.mongodb, function (err, data) {
        if (err) {
            debug(err);
            return;
        }
        
        pservices.getProjects(function (err, prjs) {
            if (err) {
                debug(err);
                return;
            }
            
            if (prjs.length == 0)
                load(function (err, data) {
                    if (err) {
                        debug(err);
                        return;
                    }
                    
                    launch();
                });
            else
                launch();
        });
    });
else
    launch();
    
function load(cb) {
    var loaddata = require('../utils/loaddata');
    loaddata('../data.json', cb);
}

function launch() {
    var server = app.listen(app.get('port'), function() {
      debug('Express server listening on port ' + server.address().port);
    });
}

